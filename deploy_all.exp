#!/usr/bin/expect -f
set timeout 600
set password "bMjVTAVByf"
set host "74.1.20.119"

puts "--- âˆ… ZERO: Iniciando Deploy Full (Backend + UI) ---"

# 1. Sincronizar pasta dist (Tudo: gateway, voice, shared, control-ui, etc.)
# Usando rsync com --delete para limpar arquivos antigos e garantir integridade
puts "ðŸ“¡ Sincronizando pasta dist (Backend + Frontend)..."
spawn rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" dist/ root@$host:/opt/zero/dist/
expect "password:" { send "$password\r" }
expect eof

# 2. Sincronizar pasta skills (ExtensÃµes traduzidas)
puts "ðŸ“¡ Sincronizando pasta skills..."
spawn rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" skills/ root@$host:/opt/zero/skills/
expect "password:" { send "$password\r" }
expect eof

# 2. Sincronizar ui/index.html (se necessÃ¡rio, embora jÃ¡ esteja no dist/control-ui)
puts "ðŸ“¡ Verificando index.html principal..."
spawn scp -o StrictHostKeyChecking=no ui/index.html root@$host:/opt/zero/ui/index.html
expect "password:" { send "$password\r" }
expect eof

# 3. Reiniciar o serviÃ§o no VPS
puts "ðŸ”„ Reiniciando zero-gateway no PM2..."
spawn ssh root@$host "pm2 restart zero-gateway"
expect "password:" { send "$password\r" }
expect eof

puts "--- âœ… Deploy concluÃ­do com sucesso ---"
